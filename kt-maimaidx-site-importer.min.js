!function(){"use strict";console.log("KTIMPORT");const e="prod",t={staging:{baseUrl:"https://staging.kamaitachi.xyz",clientId:"CI5ba595889dca0ebf15f700291084bbf26d199ee4"},prod:{baseUrl:"https://kamai.tachi.ac",clientId:"CIaf985c87034413cd78328c9cad474ed032822125"}},r=t[e].baseUrl,n=t[e].clientId,i="api-key",o="latest-score-date",c=["BASIC","ADVANCED","EXPERT","MASTER","Re:MASTER"];function a(t){return localStorage.getItem(`__ktimport__${t}_${e}`)}function s(t,r){return localStorage.setItem(`__ktimport__${t}_${e}`,r.toString())}function l(e){return new URL(e).pathname.split("/").pop().split(".").shift()}function m(){window.open(`${r}/client-file-flow/${n}`);document.querySelector("header").insertAdjacentHTML("afterend",'\n\t<div id="api-key-setup" style="background-color: #fff">\n\t  <form id="api-key-form">\n\t\t<input type="text" id="api-key-form-key" placeholder="Copy API Key here"/>\n\t\t<input type="submit" value="Save"/>\n\t  </form>\n\t</div>\n\t'),document.querySelector("#api-key-setup").addEventListener("submit",u)}async function u(e){e.preventDefault();const t=document.querySelector("#api-key-form-key").value;if(/^[0-9a-f]+$/gu.test(t))try{p("Verifying API key. The page will automatically reload once verification is successful.");const e=await fetch(`${r}/api/v1/users/me`,{headers:{Authorization:`Bearer ${t}`}}).then((e=>e.json()));if(!e.success)return void p(`Invalid API key: ${e.description}`);s(i,t),location.reload()}catch(e){p(`Could not verify API key: ${e}`)}else p("Invalid API key. Expected a hexadecimal string.")}function d(e,t){!a(i)&&window.confirm("You don't have an API key set up. Please set up an API key before proceeding.")&&(location.href="/maimai-mobile/home/");const r=document.createElement("a");r.id="kt-import-button",r.classList="music_master_btn pointer p_5 t_c f_12 f_b white",r.borderRadius="8px",r.backgroundColor="#F31A7D",r.display="block",r.margin="10px auto",r.padding="5px",r.width="fit-content",r.append(document.createTextNode(e));document.querySelectorAll(".title")[0].insertAdjacentElement("afterend",r),document.querySelector("#kt-import-button").onclick=t}function p(e){let t=document.querySelector("#kt-import-status");if(!t){t=document.createElement("p"),t.id="kt-import-status",t.style="text-align: center; background-color: #fff;";document.querySelectorAll(".title")[0].insertAdjacentElement("afterend",t)}t.innerText=e}async function f(e,t,r,n=null){const c=await fetch(e,{method:"GET",headers:{Authorization:`Bearer ${a(i)}`}}),l=await c.json();if(l.success){if("ongoing"===l.body.importStatus)return p("Importing scores... "+l.description+" Progress: "+l.body.progress.description),void setTimeout(f,1e3,e,t,r);if("completed"===l.body.importStatus){console.log(l.body);let e=l.description+` ${l.body.import.scoreIDs.length} scores`;if(t&&(e+=` and Dan ${t}`),r&&(e+=` and Class ${r}`),l.body.import.errors.length>0){e+=`, ${l.body.import.errors.length} errors (see console log for details)`;for(const e of l.body.import.errors)console.log(`${e.type}: ${e.message}`)}return n&&s(o,n),void p(e)}p(l.description)}else p("Terminal Error: "+l.description)}async function _(e){const{scores:t=[],dan:n=null,matchingClass:o=null,saveLatestTimestamp:c=!1}=e;let s={};if(n&&(s.dan={1:"DAN_1",2:"DAN_2",3:"DAN_3",4:"DAN_4",5:"DAN_5",6:"DAN_6",7:"DAN_7",8:"DAN_8",9:"DAN_9",10:"DAN_10",11:"SHINDAN_1",12:"SHINDAN_2",13:"SHINDAN_3",14:"SHINDAN_4",15:"SHINDAN_5",16:"SHINDAN_6",17:"SHINDAN_7",18:"SHINDAN_8",19:"SHINDAN_9",20:"SHINDAN_10",21:"SHINKAIDEN",22:"URAKAIDEN"}[n]),o&&(s.matchingClass={0:"B5",1:"B4",2:"B3",3:"B2",4:"B1",5:"A5",6:"A4",7:"A3",8:"A2",9:"A1",10:"S5",11:"S4",12:"S3",13:"S2",14:"S1",15:"SS5",16:"SS4",17:"SS3",18:"SS2",19:"SS1",20:"SSS5",21:"SSS4",22:"SSS3",23:"SSS2",24:"SSS1",25:"LEGEND"}[o]),0===t.length&&0===Object.entries(s).length)return void p("Nothing to import.");const l={meta:{game:"maimaidx",playtype:"Single",service:"site-importer"},scores:t,classes:s};console.log(JSON.stringify(l));const m=fetch(`${r}/ir/direct-manual/import`,{method:"POST",headers:{Authorization:"Bearer "+a(i),"Content-Type":"application/json","X-User-Intent":"true"},body:JSON.stringify(l)});document.querySelector("#kt-import-button")?.remove(),p("Submitting scores...");const u=(await(await m).json()).body.url,d=t.length>0&&c?Math.max(...t.map((e=>e.timeAchieved.valueOf()))):null;p("Importing scores..."),f(u,n,s.matchingClass,d)}function y([e,t],r){const n={clear:"CLEAR",fc:"FULL COMBO",fcplus:"FULL COMBO+",fcp:"FULL COMBO+",ap:"ALL PERFECT",applus:"ALL PERFECT+",app:"ALL PERFECT+"};let i=null;return i="fc_dummy"===t?n[e]:n[t],null==i&&(i=r>=80?"CLEAR":"FAILED"),i}function S(e){if(e.id)return e.id.includes("sta_")?"standard":"dx";const t=e.querySelector(".music_kind_icon, .playlog_music_kind_icon");return t instanceof HTMLImageElement?l(t.src).replace("music_",""):"dx"}function g(e,t,r){let n=l(e.querySelector(t).src).replace("diff_","");return n=n.replace(n[0],n[0].toUpperCase()),"Remaster"===n&&(n="Re:Master"),"dx"===r&&(n="DX "+n),n}function h(e){return e.includes("e90f79d9dcff84df")}async function b(e=null){const t=await k(`/maimai-mobile/record/musicDetail/?idx=${encodeURIComponent(e)}`).then((e=>e.text())),r=(new DOMParser).parseFromString(t,"text/html"),n=r.querySelector(".basic_block img")?.src;return n?h(n):r.querySelector(".m_10.m_t_5.t_r.f_12").innerText.includes("niconico")}function A(e){const t=e.match("([0-9]{4})/([0-9]{1,2})/([0-9]{1,2}) ([0-9]{1,2}):([0-9]{2})");let[r,n,i,o,c,a]=t;i=i.padStart(2,"0"),o=o.padStart(2,"0"),c=c.padStart(2,"0");return new Date(`${n}-${i}-${o}T${c}:${a}:00.000+09:00`)}async function k(e,t){const r=await fetch(e,t);if(503===r.status)throw p("maimai DX NET is currently undergoing maintenance. Please import your scores later."),new Error("maimai DX NET is under maintenance.");if("/maimai-mobile/error/"===new URL(r.url).pathname){const e=await r.text(),t=(new DOMParser).parseFromString(e,"text/html").querySelector(".container_red"),n=t?.querySelector(".p_5.f_14"),i=t?.querySelector(".p_5.f_12");if(!n||!i)throw console.error(e),p("An unknown maimai DX NET error occured."),new Error("An unknown maimai DX NET error occured.");const o=n.textContent?.split("：")?.[1],c=i.textContent;throw p(`maimai DX NET error ${o}: ${c}`),new Error(`maimai DX NET error ${o}: ${c}`)}return r}async function N(e=document){const t=Number(a(o)??0),r=[...e.querySelectorAll(".p_10.t_l.f_0.v_b")].filter((e=>A(e.querySelector(".sub_title .v_b:not(.red)").innerHTML).valueOf()>t));let n="...";t>0&&(n=` since ${new Date(t).toLocaleString()}...`);let i=[];for(let e=0;e<r.length;e++){p(`Fetching recent score ${e+1}/${r.length}${n}`);const t=r[e];let o={percent:0,lamp:"",matchType:"songTitle",identifier:"",difficulty:"",timeAchieved:0,judgements:{pcrit:0,perfect:0,great:0,good:0,miss:0},hitMeta:{fast:0,slow:0,maxCombo:0}};if(o.identifier=t.querySelector(".basic_block.m_5.p_5.p_l_10.f_13.break").innerText,"　"===o.identifier&&(o.identifier=""),"Link"===o.identifier){const e=t.querySelector(".p_r.f_0 img").src;o.matchType="tachiSongID",o.identifier=h(e)?"244":"68"}"TRUST"!==o.identifier&&"Trust"!==o.identifier||(o.matchType="tachiSongID",o.identifier="TRUST"===o.identifier?"461":"1385");const c=g(t,".playlog_diff.v_b",S(t));if("Utage"===c||"DX Utage"===c){console.log(`Ignoring score ${o.identifier} [${c}].`);continue}o.difficulty=c;const a=t.querySelector(".playlog_achievement_txt.t_r").innerHTML.replace('<span class="f_20">',"").replace("</span>","");if(o.percent=parseFloat(a.match(/[0-9]+.[0-9]+/)[0]),o.percent>101){console.warn(`Ignoring score ${o.identifier} [${c}] because ${o.percent} > 101%.`);continue}const s=t.querySelector(".w_80.f_r");let m=null;null!==s&&(m=l(s.src));const u=l(t.querySelector(".playlog_result_innerblock.basic_block.p_5.f_13").children[1].src);o.lamp=y([m,u],o.percent);const d=t.querySelector(".sub_title.t_c.f_r.f_11").getElementsByClassName("v_b")[1];o.timeAchieved=A(d.innerHTML).valueOf();const f=t.querySelector(".m_t_5.t_r").getElementsByTagName("input")[0].value;let _=await k(`/maimai-mobile/record/playlogDetail/?idx=${f}`),b=(new DOMParser).parseFromString(await _.text(),"text/html");[...b.querySelector(".playlog_notes_detail.t_r.f_l.f_11.f_b").querySelectorAll("tr")].slice(1).map((e=>{o.judgements.pcrit=o.judgements.pcrit+Number(e.querySelectorAll("td")[0].innerHTML),o.judgements.perfect=o.judgements.perfect+Number(e.querySelectorAll("td")[1].innerHTML),o.judgements.great=o.judgements.great+Number(e.querySelectorAll("td")[2].innerHTML),o.judgements.good=o.judgements.good+Number(e.querySelectorAll("td")[3].innerHTML),o.judgements.miss=o.judgements.miss+Number(e.querySelectorAll("td")[4].innerHTML)})),o.hitMeta.fast=Number(b.querySelectorAll(".w_96.f_l.t_r")[0].textContent),o.hitMeta.slow=Number(b.querySelectorAll(".w_96.f_l.t_r")[1].textContent),o.hitMeta.maxCombo=Number(b.querySelector(".f_r.f_14.white").innerHTML.match(/([0-9]+)\/([0-9]+)/)[1]),i.push(o)}_({scores:i,saveLatestTimestamp:!0})}async function T(){const e=[];for(let t=0;t<5;t++){p(`Fetching scores for ${c[t]}...`);const r=await k(`/maimai-mobile/record/musicGenre/search/?genre=99&diff=${t}`),n=(new DOMParser).parseFromString(await r.text(),"text/html").querySelectorAll(".w_450.m_15.p_r.f_0");for(const t of n){let r={percent:0,lamp:"",matchType:"songTitle",identifier:"",difficulty:g(t,".h_20.f_l",S(t))};if(r.identifier=t.querySelector(".music_name_block.t_l.f_13.break").innerText,"　"===r.identifier&&(r.identifier=""),"Link"===r.identifier){const e=t.querySelector("form input[name=idx]").value;r.matchType="tachiSongID",r.identifier=await b(e)?"244":"68"}"TRUST"!==r.identifier&&"Trust"!==r.identifier||(r.matchType="tachiSongID",r.identifier="TRUST"===r.identifier?"461":"1385");const n=t.querySelector(".music_score_block.w_112.t_r.f_l.f_12");if(null===n)continue;r.percent=parseFloat(n.innerText.match(/[0-9]+.[0-9]+/)[0]);const i=l(t.querySelectorAll(".h_30.f_r")[1].src).replace("music_icon_","");r.lamp=y(["",i],r.percent),e.push(r)}}document.querySelector("#kt-import-pb-warning")?.remove(),_({scores:e})}async function w(){const e=document.querySelector(".h_35.f_l").src;let t=Number(l(e).replace("course_rank_","").substring(0,2));t>11&&(t-=1);const r=document.querySelector(".p_l_10.h_35.f_l").src,n=Number(l(r).replace("class_rank_s_","").substring(0,2));await _({dan:t,matchingClass:n})}switch("undefined"!=typeof GM_fetch&&(fetch=GM_fetch),console.log("running"),location.pathname){case"/maimai-mobile/record/musicGenre/":case"/maimai-mobile/record/musicWord/":case"/maimai-mobile/record/musicLevel/":case"/maimai-mobile/record/musicVersion/":case"/maimai-mobile/record/musicSort/":d("IMPORT ALL PBs",(function(){document.querySelector("#kt-import-button").remove(),d("Confirm DANGEROUS operation",(async()=>await T())),document.querySelector("#kt-import-button").insertAdjacentHTML("afterend",'\n\t<p id="kt-import-pb-warning" class="p_10" style="text-align: center; background-color: #fff">\n\t  <span style="color: #f00">WARNING!</span>\n\t  PB import is not recommended in general! PBs do not have timestamp data, and will not create\n\t  sessions. Only import PBs <em>after</em> importing recent scores.\n\t</p>\n\t')}));break;case"/maimai-mobile/record/":d("IMPORT RECENT SCORES",(async()=>await N(document)));break;case"/maimai-mobile/home/":!function(){const e=document.querySelectorAll(".comment_block.break.f_l.f_12")[0],t=!!a(i),r=document.createElement("p");t||(r.append(document.createTextNode("You don't have an API key set up. Please set up an API key before proceeding.")),r.append(document.createElement("br")));let n=t?"Reconfigure API key (if broken)":"Set up API key";const o=document.createElement("a");o.id="setup-api-key-onclick",o.append(document.createTextNode(n)),o.onclick=m,r.append(o);const c=document.createElement("div");if(c.append(r),t){const e=document.createElement("a"),t="Import recent scores (preferred)";e.onclick=async()=>{const e=await k("/maimai-mobile/record/"),t=(new DOMParser).parseFromString(await e.text(),"text/html");await N(t)},e.append(t),e.append(document.createElement("br")),c.append(e);const r=document.createElement("a"),n="Import all PBs";r.onclick=T,r.append(n),r.append(document.createElement("br")),c.append(r);const i=document.createElement("a"),o="Import dan and matching class";i.onclick=w,i.append(o),c.append(i)}e.append(c),e.id="kt-import-status"}();break;case"/maimai-mobile/playerData/":d("IMPORT DANS AND CLASSES",(async()=>await w()))}}();
